 $.ajaxSetup({
	headers: {
		'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	}
});

var sort_li = function(a, b) {
    return ($(b).data('order')) > ($(a).data('order')) ? 1 : -1;
}

$(function(){


    $(document).on('touchstart click', ".task_maximizer", function(event) {
        event.preventDefault();
        var view_type=$("div.task__list-type>button:disabled").attr("gid");
        //console.log(view_type);
        var url = site_url+'/goals/view/'+view_type;
        window.location.href = url;
    });

    $(document).on('ifChanged', "ul.habit-list input.habits__checkbox", function(e) {
            //console.log("ifChanged called....");
			var _this = $(this);
            add_log(e,_this);
	});

    $(document).on('change', ".mobile-view ul.habit-list input.habits__checkbox", function(e) {
            
            //console.log("is for mobile...");
            
            var _this = $(this);
            
            if(_this.attr("data-value")==1){
                _this.attr("data-value",2);
            }else if(_this.attr("data-value")==2){
                _this.attr("data-value",0);
            }else{
                 _this.attr("data-value",1);
            }

            add_log(e,_this);
    });

    $(document).on('touchstart click', ".prev-week,.prev-date", function(event) {

        //console.log("prev-week");

         var date=$(this).attr("data-date");
         
         var type="prev";

         weekly_habits(date,type);
    });

    $(document).on('touchstart click', ".next-week,.next-date", function(event) {
         
         //console.log("next-week");
         
         var date=$(this).attr("data-date");
         
         var type="next";

         weekly_habits(date,type);
    });

    $(document).on('touchstart click', ".today", function(event) {
         
         //console.log("next-week");
         
         var date=$(this).attr("data-date");
         
         var type="today";

         weekly_habits(date,type);
    });

    

    //$("ul.habit-list").on('click', 'a.habit-datepicker', function() {
    $(document).on('touchstart click', "a.habit-datepicker", function(event) {
        
        //alert("clicked.....");

        habit_calender($(this));
    });


    $('#myModal').on('show.bs.modal', function(e) {
        indexyr = 0;
        var rowid = $(e.relatedTarget).attr('data-pid');
        $('.loader-section').show();
        $('.habit-per-graph .modal-body .modal-body-data').html("");

    });

    $(document).on('touchstart click', ".show-task-link", function(event) {
       
       var _this=$(this);

       var parent=$(this).parents("li:first");
       
       if(parent.hasClass("child-expand")){
            parent.removeClass("child-expand").addClass("child-collapse");
            _this.find("i.fa").removeClass("fa-chevron-down").addClass("fa-chevron-right");
       }else{
            parent.removeClass("child-collapse").addClass("child-expand");
            _this.find("i.fa").removeClass("fa-chevron-right").addClass("fa-chevron-down");
       }
       var auto_save_id=_this.attr("data-autosaveid");
        $.tloader("show","Loading...");

        $.post(site_url+'/goals/state',{auto_save_id:auto_save_id, self: false}, function(response) {
        
        $.tloader("hide");

        if (response.status == 1)
            {
                //console.log(response);
                //$("div#task_displayer").html(response.html);
                //window.reload();
            }
        });

    });
    
    
    $("#trophy_date").datepicker({dateFormat:"yy-mm-dd"});

    $(document).on("touchstart click", ".btnPopupTrophy",function(){

            $.tloader("show","Adding task to trophy, Please wait...");
            
            var trophy_date=$("#trophy_date").val();
            
            var trophy_name=$("#trophy_name").val();
            
            var trophy_id=$("#trophy_id").val();
            
            var error=new Array;
            
            if(!trophy_date){
                error.push("Please Enter Date.");
            }

            if(!trophy_name){
                error.push("Please Enter Trophy Name.");
            }

            if(!trophy_id){
                error.push("Invalid Task. Please report to administrator.");
            }

            if(error.length){
                
                $.tloader("hide");

                $.notify(error.join("<br/>"), {
                    type:'danger',
                    z_index: 999999999,
                });
                


                return false;
            }

           

            $.post(site_url+'/trophy/movetotrophy',{item_id:trophy_id, trophy_date:trophy_date, name:trophy_name}, function(response) {
                
                if(response.status == 1){
                    $("#myTrophyModal").modal("hide");
                }


                $.notify(response.msg, {
                    type:'success',
                    z_index: 999999999,
                });

                $.tloader("hide");
            });
    });

    $(document).on("touchstart click",".like.btnEnd",function(){
        
        var _this=$(this);

        var active_list = _this.attr("data-view");

        var id=_this.attr("data-id");
        
        $.tloader("show","Loading...");

        $.post(site_url+'/goals/task_complete',{id:id,view_type:active_list}, function(response) {
        
        $.tloader("hide");

        console.log("completing .....");

        //console.log(response);

        if (response.status == 1)
            {
                
                //$("#trophy_date").val(response.data.due_date);

                $("#trophy_name").val(response.data.name);
                $("#trophy_id").val(response.data.id);

                var myTrophyModal=$("#myTrophyModal").modal();

                if(isMobile){
                    $("div#"+active_list+"-mobile").html(response.html);
                }else{
                   $("div#task_displayer").html(response.html); 
                }
              
              init_change_task_date();  
             
            }

            init_task_sortable();
        });

    });

    $(document).on('touchstart click', ".task__list-type button", function(event) {
        $(".task__list-type button").removeAttr("disabled");
        var _this=$(this);
        var type=_this.attr("gid");
        _this.attr("disabled",true);
        load_task_tree(type);
    });

    $(document).on('touchstart click', ".tasks-mobile-tabs li a", function(event) {
        var _this=$(this);
        
        var type=_this.attr("gid");
        
        $(".tasks-mobile-tabs li").removeClass("active");
        _this.parent("li").addClass("active");
        $(".mobile_task_displayer>div").removeClass("in active");
        $(".mobile_task_displayer>div#"+type+"-mobile").addClass("in active");
        load_mobile_task_tree(type);
    });
    
    
    /*$.datepicker._findPos = function (obj) {
        var position,
            inst = this._getInst(obj),
            isRTL = this._get(inst, "isRTL");

        while (obj && (obj.type === "hidden" || obj.nodeType !== 1 || $.expr.filters.visible(obj))) {
            obj = obj[isRTL ? "previousSibling" : "nextSibling"];
        }

        position = $(obj).offset();
        console.log(position);
        // if element type isn't hidden, use show and hide to find offset
        if (!position) { position = $(obj).show().offset(); $(obj).hide();}
        // or set position manually
        if (!position) position = {left: 999, top:999};
        return [position.left, position.top]; 
    };*/

    //$(".task-list-tree").children("li");
    
    /*setTimeout(function() {
        console.log("ddddd....d");
        init_task_sortable();
        // The LI is now appended to #cart UL and you can mess around with it.
    }, 1);*/


    init_change_task_date();
    init_habit_sortable();
    init_character_sortable();
    init_task_sortable();
    init_change_habit_date();

});


var add_log = function(e,_this){
    
    var full_date_php = _this.attr('gdate');
    
    var gid = _this.attr('gid');
    
    var value = parseInt(_this.attr('data-value'));

    var isChecked = e.currentTarget.checked;
    
    //console.log("isChecked:"+isChecked);

    //console.log("value:"+value);

    var notava = false;

    if(!isMobile){  // for desktop only...
        if (isChecked && value == 0) {
            value = 1;
        } else if (isChecked && value == 1) {
            //value = 2;
        } else if (!isChecked && value == 1) {
            value = 2;
            notava = true;
        } else if (!isChecked && value == 2) {
            value = 0;
        } else if (isChecked && value == 2) {
            value = 0;
        }
    }

    //$.tloader("show","Loading..."); 
    $.post(site_url+'/log/add', 
        {id: gid, value: value, date: full_date_php}, 
        function(response) {
            //$.tloader("hide"); 
        if (response.status == 1)
            {
                _this.removeClass("notavailable");
                _this.attr('data-value',response.data.value);
                if(parseInt(response.data.value)==2){
                    _this.addClass("notavailable");
                }else if(parseInt(response.data.value)==0){
                    _this.attr("checked", false);
                }
                
                var parent_li=_this.parents(".main-li");

                var percent=response.data.percentage.percentage+"%";
                parent_li.find(".habits__process-percent").html(percent);

                parent_li.find(".change-badge").removeClass("badge-danger badge-warning badge-success").addClass(response.data.percentage.badge);
                var _process="("+response.data.percentage.completed_days+"/"+response.data.percentage.total_days+")";
                parent_li.find(".habits__process").html(_process);
            }
    },"json");
}


var load_mobile_task_tree = function(type){

    $.tloader("show","Loading...");

    $.post(site_url+'/goals/task_list',{view_type: type}, function(response) {
       if (response.status == 1)
        {       
                $("ul.task-main-tree").remove();
                $("div.mobile_task_displayer > div#"+type+"-mobile").html(response.html);
                init_task_sortable();
                init_change_task_date();
        }
        $.tloader("hide");
    });
};



var load_task_tree = function(type){

    $.tloader("show","Loading...");

    $.post(site_url+'/goals/task_list',{view_type: type}, function(response) {
    
    $.tloader("hide");
    
    //console.log(response);

    if (response.status == 1)
        {
            $("div#task_displayer").html(response.html);
            init_task_sortable();
            init_change_task_date();
        }
    });
};

var weekly_habits=function(date,type){

    $.tloader("show","Loading...");

    $.post(site_url+'/goals/weekly_habits',{date: date, type: type}, function(response) {
    
    $.tloader("hide");
    
    if (response.status == 1)
        {
            $("div.habits-container").html(response.html);
            init_habit_sortable();
            init_change_habit_date();
        }
    });
}

var init_change_habit_date = function(){


    $('input._habit_datepicker').datepicker({
        dateFormat: "yy-mm-dd",
        changeMonth: true,
        changeYear: true,
        onSelect: function( current_date, evnt ) {
            
            var _this=evnt.input

            var habit_id=_this.data("id");
            
            //console.log(task_id);
            
            _this.val(current_date);
           
            $.tloader("show","Loading...");

            $.post(site_url+'/goals/upadate_habit_date',{date: current_date, id: habit_id}, function(response) {
            
            $.tloader("hide");

            
            if (response.status == 1)
            {   
                if(response.data.expired){
                    _this.parent().addClass("red");
                }else{
                    _this.parent().removeClass("red");
                }
            }
           

            });

        }
    });

    $("div.habits__process").click(function(){
        var habit_calender = $(this).next();
        habit_calender.focus();
    });

};

var init_change_task_date = function(){
    
    $('.task-link .task-date-picker').datepicker({
        dateFormat: "dd M, yy",
        changeMonth: true,
        changeYear: true,
        onSelect: function( current_date, evnt ) {
            
            var _this=evnt.input

            var task_id=_this.data("id");
            
            //console.log(task_id);
            
            _this.val(current_date);

            var view_type=$("div.task__list-type>button:disabled").attr("gid");
           
            $.tloader("show","Loading...");

            $.post(site_url+'/goals/upadate_task_date',{date: current_date, id: task_id, type:view_type}, function(response) {
            
            $.tloader("hide");

            
            if (response.status == 1)
            {   
                if(response.data.expired){
                    _this.parent().addClass("red");
                }else{
                    _this.parent().removeClass("red");
                }
            }
           

            });

        }
    });
};


Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
}

var habit_calender = function(_this){

    //console.log("called....1");

    var max_date = new Date();
    var max_date=max_date.addDays(365);

    //console.log(max_date);

    $.tloader("show","Loading Calender...");

    var input = $('.list_calendar').pickadate({
        today: '',
        clear: '',
        close: 'Close',
        selectYears: 200,
        selectMonths: true,
        max: max_date,
        onRender: function() {
            $('.picker__box').prepend('<a href="javascript:;" class="close_calender">X</a>');

            //console.log('Whoa.. rendered anew')
        }
    });

    //console.log("called....2");

    var picker = input.pickadate('picker');

    //var _this = $(this);

    var gid = _this.attr('gid');   

    //console.log("called....3");
    
    $.get(site_url+'/log/list/' + gid, function(response) {
        
        $.tloader("hide");
        
        picker.start();
        
        //console.log(response.data.start_date);
        
        var min_date=response.data.start_date.split(",");
        
        //console.log(min_date);
        
        picker.set('min', [parseInt(min_date[0]), parseInt(min_date[1])-1, parseInt(min_date[2])]);

        var disabled=[];
        if(response.data.disabled_dates.length){
            $.each(response.data.disabled_dates,function(i,date){
                //console.log(date);
                var new_date=date.split(",");
                disabled[i]=[parseInt(new_date[0]), parseInt(new_date[1])-1, parseInt(new_date[2])];//push(new Date(new_date[0],new_date[1]-1,new_date[2]));
            });
        }

        var completed=[];
        if(response.data.completed_dates.length){
            $.each(response.data.completed_dates,function(i,date){
                var new_date=date.split(",");
                completed[i]=[parseInt(new_date[0]), parseInt(new_date[1])-1, parseInt(new_date[2])];//push(new Date(new_date[0],new_date[1]-1,new_date[2]));
            });
        }
        
        picker.set('disable', disabled);
        picker.on({
            open: function() {

                //console.log("calender opening...");
                set_id();
                reload_table(completed, 'checked__day');

                pic_date(picker, gid,function(pick, status){

                    var date = convertDbDate(pick);

                    var d = new Date(date);
                    
                    if(status==0){
                        remove_date(disabled, pick);
                    }else if(status==2){
                       remove_date(completed, pick);
                       disabled.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);
                       //console.log(disabled);
                    }else{
                      remove_date(completed, pick);  
                      completed.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);
                    }


                });
            },
            set: function(timestamp) {
                
                set_id();
                
                reload_table(completed, 'checked__day');

                $('.close_calender').on('click', function() {
                    picker.stop();
                });

                pic_date(picker, gid,function(pick, status){

                    var date = convertDbDate(pick);

                    var d = new Date(date);
                    
                    if(status==0){
                        remove_date(disabled, pick);
                    }else if(status==2){
                       remove_date(completed, pick);
                       disabled.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);
                    }else{
                      remove_date(completed, pick);  
                      completed.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);
                    }
                });
            },
            render: function() {
                    //set_id();
            }
        });

        picker.open();

        $(document).on('click', function() {
            picker.stop();
        });
        $('.close_calender').on('click', function() {
            //console.log('close cal');
            //   input.cl();
            picker.stop();
        });
    });                                     
}

var pic_date = function(picker, gid, callback){
   
    $('.picker__day').unbind("click").bind("click", function() {
        
        //console.log("picking a date...");

        $.tloader("show","Please wait...");

        var value = $(this).attr('data-pick');

        var date = convertDbDate(value);

        var d = new Date(value);
        var date_id = '#' + value;

        var status=0;
        if ($(this).hasClass('picker__day--disabled')) {

            log_date(gid, 0, date, date_id);
            status=0;
        } else if ($(this).hasClass('checked__day')) {
            status=2;
            log_date(gid, 2, date, date_id);
        } else if (!$(this).hasClass('checked__day') && !$(this).hasClass('picker__day-disabled')) {
            status=1;
            log_date(gid, 1, date, date_id);
        }
        callback(value, status);
        return false;

    });
} 

var log_date = function(gid, value, date, date_id){

    //$("input[type='checkbox'][gdate='"+date+"']");
    var _this=$('input[type="checkbox"][gdate="'+date+'"][gid="'+gid+'"]');
    
    //console.log(_this);
    
    $.post(site_url+'/log/add', {id: gid, value: value, date: date}, function(response) {
        
        if(response.status==1){
            
            if(parseInt(response.data.value)==1){
                $(date_id).addClass('checked__day');
            }else if(parseInt(response.data.value)==2){
                $(date_id).removeClass('checked__day');
                $(date_id).addClass('picker__day--disabled');
            }else{
                $(date_id).removeClass('picker__day--disabled');
            }

            if(_this.length){
               
                _this.removeClass("notavailable");
               
                _this.attr('data-value',response.data.value);
                
                console.log(parseInt(response.data.value));

                if(parseInt(response.data.value)==2){
                     _this.parent(".icheckbox_flat-green").removeClass("checked");
                    _this.addClass("notavailable");
                }else if(parseInt(response.data.value)==0){
                    _this.parent(".icheckbox_flat-green").removeClass("checked");
                    _this.attr("checked", false);
                }else{
                    console.log("Else....");
                    _this.attr("checked", true);
                    _this.parent(".icheckbox_flat-green").addClass("checked");
                    _this.iCheck('check');
                }

                _this.iCheck("update");
            }
            
            var parent_li=$("li#item_"+gid);

            var percent=response.data.percentage.percentage+"%";
            parent_li.find(".habits__process-percent").html(percent);

            parent_li.find(".habits__process-percent").removeClass("badge-danger badge-warning badge-success").addClass(response.data.percentage.badge);
            var _process="("+response.data.percentage.completed_days+"/"+response.data.percentage.total_days+")";
            parent_li.find(".habits__process").html(_process);
        }

        $.tloader("hide");
    });
}


var init_habit_sortable=function(){

    var habits_list=$('ul.habit-list').sortable({
        handle: 'div.arrows-holder',
        items: 'li.main-li',
        listType: 'ul',
        opacity: .6,
        stop: function(event, ui) { 
            $.tloader("show","Hang On...");
            var data = habits_list.sortable("serialize");
            


            $.post(site_url+"/goals/self_order", {data:data}, function (response) {
                //console.log(response)
                if (response.status == 0)
                {

                }
                $.tloader("hide");
            });
        }
    });
    habits_list.disableSelection();
};

var init_character_sortable=function(){

    var character_list=$('ul.character-list').sortable({
        handle: 'div.arrows-holder',
        items: '>li.main-li',
        listType: 'ul',
        opacity: .6,
        stop: function(event, ui) {
            $.tloader("show","Hang On...");
            var data = character_list.sortable("serialize");
            $.post(site_url+"/goals/self_order", {data:data}, function (response) {
               
                if (response.status == 0)
                {

                }

                $.tloader("hide");
            });

            //console.log('new parent ' + ui.item.closest('ul').closest('li').attr('name'));
        }
    });
    character_list.disableSelection();
};

var init_sort_task = function(){

    $(".task-list-tree li.mainchild").sort(sort_li).detach().appendTo('.task-list-tree');
    $("#task-mobile li.mainchild").sort(sort_li).detach().appendTo('#task-mobile');

    $("#task_displayer_loader").remove();
};

var init_task_sortable=function(){
        
        init_sort_task();

    var task_list=$('ul.task-list-tree').sortable({
        handle: 'span.arrows-holder',
        items: '>li.task-item',
        listType: 'ul',
        opacity: .6,
        stop: function(event, ui) {
           
           /* $.tloader("show","Hang On...");
            
            var data = task_list.sortable("serialize");

            var ulli=ui.item.parent().children("li");

            console.log(ulli);

            //return false;
            //console.log(ulli.find(">li:first-child"));

            var manual_serialize=new Array();

            $.each(ulli,function(i, li){
                
                //console.log(li);

                //console.log(i);

                var id = $(li).attr("id");
                
                var key_value=id.split("_");
                
                var key = key_value[0]+"[]="+key_value[1];
                
                manual_serialize.push(key);
                
                console.log(manual_serialize);

            });
            
            var params=manual_serialize.join("&");

            console.log(params);

            $.post(site_url+"/goals/self_order", {data:params}, function (response) {
               
                if (response.status == 0)
                {

                }

                $.tloader("hide");
            });
            */
        },
        update: function(event, ui){

            var ulli=ui.item.parent().children("li");

            var manual_serialize=new Array();

            $.each(ulli,function(i, li){
             
                var id = $(li).attr("id");
                
                var key_value=id.split("_");
                
                var key = key_value[0]+"[]="+key_value[1];
                
                manual_serialize.push(key);
                
                //console.log(manual_serialize);

            });
            
            var params=manual_serialize.join("&");

            //console.log(params);

            $.post(site_url+"/goals/self_order", {data:params}, function (response) {
               
                if (response.status == 0)
                {

                }

                $.tloader("hide");
            });
        }
    });
    task_list.disableSelection();

    //$("ul.task-list-list").sortable("disable");
    //$("ul.task-list-leaf").sortable("disable");
};

var convert = function (timestamp) {
    var objDate = new Date(parseInt(timestamp));
    var date = objDate.getFullYear() + ',' + objDate.getMonth() + ',' + objDate.getDate();
    return date;
}

var convertDbDate = function (timestamp) {
    var objDate = new Date(parseInt(timestamp));
    var date = objDate.getFullYear() + '-' + ("0" + (objDate.getMonth() + 1)).slice(-2) + '-' + ("0" + objDate.getDate()).slice(-2);
    return date;
}

var convertDbTimestamp = function (myDate) {
    
    /*console.log("new date");
    
    console.log(myDate);
    var y=(myDate[0])<10?"0"+myDate[0]:myDate[0];
    var m=(myDate[1] + 1)<10?"0"+(myDate[1] + 1):(myDate[1] + 1);
    var d=myDate[2]<10?"0"+myDate[2]:myDate[2];


    var customize_date_string=y + "-" + m + "-" + d + " 00:00:00".replace(/\s/, 'T')+"Z";

    var newdate=new Date(customize_date_string).getTime();
    
    console.log("customize_date_string: "+customize_date_string);

    console.log("new time");
    
    console.log(newdate);

    var final_value=Math.round(newdate);

    console.log("rounded new time");

    console.log(final_value);

    return final_value;
*/
    return Math.round(new Date(myDate[0] + "-" + (myDate[1] + 1) + "-" + myDate[2] + " 00:00:00:00").getTime());
}

var reload_table=function (arr, st) {
    
    for (i = 0, max = arr.length; i < max; i++) {
        //var date_id = '#' + convertDbTimestamp(arr[i]);

        var y=(arr[i][0])<10?"0"+arr[i][0]:arr[i][0];
        var m=(arr[i][1] + 1)<10?"0"+(arr[i][1] + 1):(arr[i][1] + 1);
        var d=arr[i][2]<10?"0"+arr[i][2]:arr[i][2];

        var date_id=".day"+y + "" + m + "" + d;
        
        //console.log($(date_id));

        $(date_id).addClass(st);
    }
}

var uncheck_table = function (arr, st) {
    
    for (i = 0, max = arr.length; i < max; i++) {
        
        //var date_id = '#' + convertDbTimestamp(arr[i]);

        var y=(arr[i][0])<10?"0"+arr[i][0]:arr[i][0];
        var m=(arr[i][1] + 1)<10?"0"+(arr[i][1] + 1):(arr[i][1] + 1);
        var d=arr[i][2]<10?"0"+arr[i][2]:arr[i][2];
        var date_id=".day"+y + "" + m + "" + d;

        $(date_id).removeClass(st);
    }
}

var set_id = function set_id() {
    $('.picker__day').each(function() {
        var select_date = $(this);
        var value = $(this).attr('data-pick');
        select_date.attr('id', value);
        var d=convertDbDate(value);
        //console.log(d);
        var day_class="day"+d.replace(/-/g,"");
        select_date.addClass(day_class);
    });
}

var remove_date = function (arr, st) {
    for (i = 0, max = arr.length; i < max; i++) {
        var date_id = convertDbTimestamp(arr[i]);
        if (date_id == st) {
            arr.splice(i, 1);
            break;
        }
    }
}


/*
                                        $(document).ready(function() {
                                            $('#myModal').on('show.bs.modal', function(e) {
                                                indexyr = 0;
                                                var rowid = $(e.relatedTarget).data('pid');
                                                $('.loader-section').show();
                                                $('.habit-per-graph .modal-body .modal-body-data').html("");
                                                $.ajax({
                                                    type: 'post',
                                                    url: './goal/update2', //Here you will fetch records 
                                                    data: 'rowid=' + rowid, //Pass $id
                                                    success: function(data) {
                                                        $('.loader-section').hide();
                                                        $('.habit-per-graph .modal-body .modal-body-data').html(data);//Show fetched data from database
                                                        $('#prev_graph').css('opacity','.3');
                                                        if(total_year_event == 1) {
                                                            $('#next_graph').css('opacity','.3');
                                                        } else {
                                                            $('#next_graph').css('opacity','1');
                                                        }
                                                        //alert(total_year_event);
                                                    }
                                                });
                                            });
                                        });
                                        //         $(".hide-on-mobile #habit-id ul.habit-list").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        // $(".hide-on-mobile ul.character-list").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        // $(".compact-view-goals").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        // $(".goal-create-details").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        // $(".hide-on-mobile #task_displayer").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        // $(document).ajaxSuccess(function () {
                                        //     $(".hide-on-mobile #habit-id ul.habit-list").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        //     $(".hide-on-mobile #task_displayer").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        //     $(".hide-on-mobile ul.character-list").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        //     $(".compact-view-goals").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        //     $(".goal-create-details").niceScroll({styler: "fb", cursorcolor: "#27cce4", cursorwidth: '8', cursorborderradius: '10px', background: '#424f63', spacebarenabled: false, cursorborder: '0', zindex: '1000'});
                                        // });
                                        // })
                                        var isajax = "Yes";
                                        function showAllTasks() {
                                            $(".show-task-link").each(function() {
                                                var a = $(this);
                                                var task_id = a.data('id');

                                                $.post('./goal/state/', {id: task_id, self: 0}, function(data) {
                                                    if (data.error == 0)
                                                    {
                                                        // console.log('Successful!');
                                                    }
                                                }, "json");

                                                var b = $(this).parent().parent().parent().parent();
                                                var c = b.find('> ul');
                                                console.log("is show all");
                                                c.show();
                                                $(this).removeClass('bg2');
                                                $(this).addClass('bg1');

                                            });
                                        }

                                        function display() {
                                            var e = document.getElementById('sbox1');
                                            var x = e.options[e.selectedIndex].value;
                                            if (x == 'task') {
                                                document.getElementById('task-form').style.display = 'block';
                                            } else {
                                                document.getElementById('task-form').style.display = 'none';
                                            }
                                            document.getElementById("sub-goal").innerHTML = "";
                                        }

                                        function fixHabit(position)
                                        {
                                            

                                            // Scroll to last position
                                            $('#habit-id').scrollTop(position);
                                        }

                                        function fixCheckbox()
                                        {
                                            var a = $("#habit-id");
                                           
                                            $("ul.habit-list li .habit-checkbox .regular-checkbox").each(function() {
                                                var a = $(this);
                                                // set_checkbox(a);
                                                a.on('touchstart click', function(event) {
                                                    var d = (parseInt(a.data('value')) + 1) % 3;
                                                    a.data('value', d);
                                                    // console.log(a.data('value'));
                                                    //   set_checkbox(a);
                                                });
                                            });
                                        }


                                        function fixHasSub()
                                        {
                                            // fix class has_sub
                                            $('ul.task-list li').each(function() {
                                                var _this = $(this);
                                                if (_this.children('ul')[0])
                                                {

                                                    var task_link = _this.children('div.task-container').find('span.task-content-div').children('div.task-link');
                                                    var task_id = task_link.data('id');

                                                    var task_state = task_link.data('collapse');
                                                    var task_link_title = task_link.find('a.task-link-title');

                                                    var sub_data_count= _this.children('ul').children('li').length;
                                                    
                                                    // add collapse/expand icon
                                                    if (task_state)
                                                    {

                                                        if(sub_data_count > 0){
                                                            task_link_title.before('<a href="#" class="show-task-link  " data-id="' + task_id + '"><i class="fa fa-chevron-down"></i></a>');
                                                        }

                                                        var c = task_link_title.parent().parent().parent().parent().find('> ul');
                                                        if (c.css('display') != 'none')
                                                        {
                                                            c.hide();
                                                        }


                                                        $('#subpanel_' + task_id).show();
                                                    }
                                                    else
                                                    {
                                                        if(sub_data_count > 0){
                                                            task_link_title.before('<a href="#" class="show-task-link  " data-id="' + task_id + '"><i class="fa fa-chevron-right"></i></a>');
                                                        }
                                                    }

                                                    // display progress bar
                                                    _this.children('div.task-container').children('div.task-progress-bar').css('display', 'block');
                                                }
                                            });

                                            $('.show-task-link').on('click', function() {
                                                var pid = $(this).data('id');
                                                $('#subpanel_' + pid).toggle();
                                                $(this).html($(this).html() == '<i class="fa fa-chevron-right"></i>' ? '<i class="fa fa-chevron-down"></i>' : '<i class="fa fa-chevron-right"></i>');
                                            });


                                            $(".show-task-link").each(function() {
                                                var a = $(this);
                                                var task_id = a.data('id');


                                                a.bind('touchstart click', function(event) {
                                                    $.post('./goal/state/', {id: task_id, self: 0}, function(data) {
                                                        if (data.error == 0)
                                                        {
                                                            // console.log('Successful!');
                                                        }
                                                    }, "json");

                                                    var b = $(this).parent().parent().parent().parent();

                                                    var c = b.find('> ul');
                                                    if (c.css("display") == "none") {
                                                        c.show();
                                                        $(this).removeClass('bg2');
                                                        $(this).addClass('bg1');
                                                    } else {
                                                        c.hide();
                                                        $(this).removeClass('bg1');
                                                        $(this).addClass('bg2');
                                                    }
                                                    event.preventDefault();
                                                    return false;
                                                });
                                            });
                                        }

                                        function convert(timestamp) {
                                            var objDate = new Date(parseInt(timestamp));
                                            var date = objDate.getFullYear() + ',' + objDate.getMonth() + ',' + objDate.getDate();
                                            return date;
                                        }

                                        function convertDbDate(timestamp) {
                                            var objDate = new Date(parseInt(timestamp));
                                            var date = objDate.getFullYear() + '-' + ("0" + (objDate.getMonth() + 1)).slice(-2) + '-' + ("0" + objDate.getDate()).slice(-2);
                                            return date;
                                        }

                                        function convertDbTimestamp(myDate) {
                                            return Math.round(new Date(myDate[0] + "-" + (myDate[1] + 1) + "-" + myDate[2] + " 00:00:00:00").getTime());
                                        }
                                        function reload_table(arr, st) {
                                            for (i = 0, max = arr.length; i < max; i++) {
                                                var date_id = '#' + convertDbTimestamp(arr[i]);
                                                $(date_id).addClass(st);
                                            }
                                        }
                                        function uncheck_table(arr, st) {
                                            for (i = 0, max = arr.length; i < max; i++) {
                                                var date_id = '#' + convertDbTimestamp(arr[i]);
                                                $(date_id).removeClass(st);
                                            }
                                        }
                                        function set_id() {
                                            $('.picker__day').each(function() {
                                                var select_date = $(this);
                                                var value = $(this).data('pick');
                                                select_date.attr('id', value);
                                            });
                                        }
                                        function remove_date(arr, st) {
                                            for (i = 0, max = arr.length; i < max; i++) {
                                                var date_id = convertDbTimestamp(arr[i]);
                                                if (date_id == st) {
                                                    arr.splice(i, 1);
                                                    break;
                                                }
                                            }
                                        }

                                        var monthNames = ["January", "February", "March", "April", "May", "June",
                                            "July", "August", "September", "October", "November", "December"];

                                        var d = new Date();

                                        var strDate = d.getDate() + " " + monthNames[d.getMonth()] + ", " + d.getFullYear();

                                        $('#datepicker').attr('value', strDate);
                                        $('#datepicker').pickadate({clear: ''});

                                        var currentTaskType = 1;
                                        var current_view_typ = $('#view_type').val();

                                        console.log(current_view_typ,'current_view_typ');

                                        function taskDown() {

                                            var current_view_typ = $('#view_type').val();

                                            $.blockUI({
                                                message: '<img src="./img/ajax-loader.gif" />',
                                                css: {backgroundColor: 'transparent', border: 0}
                                            });

                                            var _this = $(this);
                                            var index = _this.attr('index');
                                            var downid = _this.attr('gid');
                                            var nexttask = _this.parent().parent().parent().parent().parent();
                                            var upid = nexttask.find('div > div.sort-div').data('gid');
                                            if (isajax == "No") {
                                                return false;
                                            }
                                            isajax = "No";
                                            $.post('./goal/swap', {downid: downid, upid: upid, type: 'task',current_view_typ:current_view_typ}, function(data) {
                                                if (data.error == 0)
                                                {

                                                    $('#task_displayer').html(data.html);
                                                    isajax = "Yes";
                                                    fixHasSub();
                                                }
                                            }, "json");
                                        }

                                        function taskUp() {
                                            var current_view_typ = $('#view_type').val();
                                            $.blockUI({
                                                message: '<img src="./img/ajax-loader.gif" />',
                                                css: {backgroundColor: 'transparent', border: 0}
                                            });

                                            var _this = $(this);
                                            var index = _this.attr('index');
                                            var upid = _this.attr('gid');

                                            var prevtask = _this.parent().parent().parent().parent().parent();
                                            var downid = prevtask.find('div > div.sort-div').data('gid');
                                            if (isajax == "No") {
                                                return false;
                                            }
                                            isajax = "No";
                                            $.post('./goal/swap', {downid: downid, upid: upid, type: 'task',current_view_typ:current_view_typ}, function(data) {
                                                if (data.error == 0)
                                                {
                                                    console.log(data.html, 'down');
                                                    $('#task_displayer').html(data.html);
                                                    isajax = "Yes";
                                                    fixHasSub();
                                                }
                                            }, "json");
                                        }

                                        function taskSub() {
                                            $.blockUI({
                                                message: '<img src="./img/ajax-loader.gif" />',
                                                css: {backgroundColor: 'transparent', border: 0}
                                            });

                                            var _this = $(this);
                                            var gid = _this.attr('gid');

                                            $.post('./goal/sub/id/' + gid, function(data) {
                                                if (data.error == 0)
                                                {
                                                    window.location.reload();
                                                }
                                            }, "json");
                                        }

                                        function taskEnd() {
                                            $.blockUI({
                                                message: '<img src="./img/ajax-loader.gif" />',
                                                css: {backgroundColor: 'transparent', border: 0}
                                            });

                                            var _this = $(this);
                                            var gid = _this.attr('gid');

                                            $.post('./goal/end/id/' + gid, function(data) {
                                                if (data.error == 0)
                                                {
                                                    var url = './goal/tasks/view_type/' + currentTaskType;
                                                    if (currentTaskType == 1)
                                                        url = './goal/index';
                                                    $.get(url, function(data) {
                                                        if (data.error == 0)
                                                        {
                                                            $('#task_displayer').html(data.html);
                                                            fixHasSub();
                                                            bindEvents();
                                                        }
                                                    }, "json");
                                                }
                                            }, "json");
                                        }


                                        function bindEvents()
                                        {

                                            $("ul.task-list").on('click', 'a.btnEnd', taskEnd);
                                            $("ul.task-list").on('click', 'a.btnSub', taskSub);
                                            $("ul.task-list").on('click', 'a.btnUp', taskUp);
                                            $("ul.task-list").on('click', 'a.btnDown', taskDown);
                                        }

                                        // unblock when ajax activity stops
                                        $(document).ajaxStop($.unblockUI);

                                        $(document).ready(function() {

                                            bindEvents();
                                            showAllTasks();

                                            var currentTaskType = 1;

                                            $(".task_trigger").each(function(index, value) {
                                                if ($(this).attr('gid') == currentTaskType) {
                                                    $(this).attr('disabled', true);
                                                } else {
                                                    $(this).attr('disabled', false);
                                                }
                                            });

                                            console.log('View type is: ' + currentTaskType);

                                            $('.task_trigger').click(function(event) {

                                                var _this = $(this);

                                                console.log(_this.attr('disabled'));

                                                if (_this.attr('disabled') == 'disabled')
                                                    return false;

                                                else {
                                                    var id = $(this).attr('gid');
                                                    currentTaskType = id;
                                                    event.preventDefault();

                                                    var current_view_typ = $('#view_type').val();

                                                    $.blockUI({
                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                        css: {backgroundColor: 'transparent', border: 0}
                                                    });

                                                    var url = './goal/tasks/view_type/' + id;
                                                    if (id == 1)
                                                        url = './goal/index/passedViewType/' + id;
                                                    $.get(url, function(data) {
                                                        if (data.error == 0)
                                                        {
                                                            $(".task_trigger").attr('disabled', false);
                                                            _this.attr('disabled', true);
                                                            $('#task_displayer').html(data.html);
                                                            fixHasSub();
                                                            bindEvents();
                                                            // showAllTasks();
                                                        }
                                                    }, "json");
                                                }

                                            });

                                            $('.task_maximizer').click(function(event) {
                                                event.preventDefault();
                                                var url = './goal/tasks/view_type/' + currentTaskType;
                                                window.location.href = url;
                                            });

                                            $('#normal_task_trigger').click(function(event) {
                                                event.preventDefault();
                                                $.blockUI({
                                                    message: '<img src="./img/ajax-loader.gif" />',
                                                    css: {backgroundColor: 'transparent', border: 0}
                                                });

                                                $.get('./goal/tasks/view_type/1', function(data) {
                                                    if (data.error == 0)
                                                    {
                                                        $('#task_displayer').html(data.html);

                                                        fixHabit(position);
                                                        fixCheckbox();
                                                        fixHasSub();
                                                    }
                                                }, "json");
                                            });

                                            // Use for scrolling to habit after ajax calling
                                            var position = 0;

                                            // fix sub goals' progress bar and collapse/expand icon
                                            fixHasSub();

                                            $("ul.habit-list").on('click', 'a.btnDown', function() {
                                                $.blockUI({
                                                    message: '<img src="./img/ajax-loader.gif" />',
                                                    css: {backgroundColor: 'transparent', border: 0}
                                                });

                                                var _this = $(this);
                                                var date = '8 February, 2018';
                                                var index = _this.attr('index');
                                                var downid = _this.attr('gid');
                                                var nextindex = parseInt(index) + 1;
                                                var upid = $('.habit-up-' + nextindex).attr('gid');

                                                // Get current position
                                                position = $('#habit-id').scrollTop();


                                                $.post('./goal/swap', {downid: downid, upid: upid, date: date, type: 'habit'}, function(data) {
                                                    if (data.error == 0)
                                                    {
                                                        $('ul.habit-list').html(data.html);



                                                        fixHabit(position);
                                                        fixCheckbox();
                                                    }
                                                }, "json");
                                            });

                                            $("ul.habit-list").on('click', 'a.btnUp', function() {
                                                $.blockUI({
                                                    message: '<img src="./img/ajax-loader.gif" />',
                                                    css: {backgroundColor: 'transparent', border: 0}
                                                });

                                                var _this = $(this);
                                                var date = '8 February, 2018';
                                                var index = _this.attr('index');
                                                var upid = _this.attr('gid');
                                                var previndex = parseInt(index) - 1;
                                                var downid = $('.habit-down-' + previndex).attr('gid');

                                                // Get current position
                                                position = $('#habit-id').scrollTop();

                                                $.post('./goal/swap', {downid: downid, upid: upid, date: date, type: 'habit'}, function(data) {
                                                    if (data.error == 0)
                                                    {
                                                        $('ul.habit-list').html(data.html);

                                                        fixHabit(position);
                                                        fixCheckbox();
                                                    }
                                                }, "json");
                                            });

                                            $("ul.habit-list").on('click', 'a.habit-datepicker', function() {
                                                $.blockUI({
                                                    message: '<img src="./img/ajax-loader.gif" />',
                                                    css: {backgroundColor: 'transparent', border: 0}
                                                });

                                                var input = $('.list_calendar').pickadate({
                                                    today: '',
                                                    clear: '',
                                                    close: 'Close',
                                                    selectYears: 200,
                                                    selectMonths: true,
                                                    onRender: function() {
                                                        $('.picker__box').prepend('<a href="javascript:;" class="close_calender">X</a>');

                                                        //console.log('Whoa.. rendered anew')
                                                    }
                                                });


                                                var picker = input.pickadate('picker');

                                                var _this = $(this);
                                                var gid = _this.attr('gid');

                                                // Get current position
                                                position = $('#habit-id').scrollTop();

                                                $.post('./log/list/id/' + gid, function(data) {
                                                    var disable = data.na;
                                                    var checked = data.checked;
                                                    var unchecked = data.unchecked;
                                                    var date_disable = [];
                                                    var date_checked = [];
                                                    var date_unchecked = [];
                                                    if (disable.length > 0)
                                                    {
                                                        var array = disable.split(';');

                                                        if (array.length > 0)
                                                        {
                                                            for (i = 0; i < array.length; i++)
                                                            {
                                                                if (array[i].indexOf(',') != -1)
                                                                {
                                                                    var temp = array[i].split(',');
                                                                    date_disable[i] = [parseInt(temp[0]), parseInt(temp[1]), parseInt(temp[2])];
                                                                } else
                                                                {
                                                                    date_disable[i] = parseInt(array[i]);
                                                                }
                                                            }
                                                        }
                                                    }

                                                    if (checked.length > 0)
                                                    {
                                                        var array_checked = checked.split(';');

                                                        if (array_checked.length > 0)
                                                        {
                                                            for (i = 0; i < array_checked.length; i++)
                                                            {
                                                                var temp_checked = array_checked[i].split(',');
                                                                date_checked[i] = [parseInt(temp_checked[0]), parseInt(temp_checked[1]), parseInt(temp_checked[2])];
                                                            }
                                                        }
                                                    }

                                                    if (unchecked.length > 0)
                                                    {
                                                        var array_unchecked = unchecked.split(';');

                                                        if (array_unchecked.length > 0)
                                                        {
                                                            for (i = 0; i < array_unchecked.length; i++)
                                                            {
                                                                var temp_unchecked = array_unchecked[i].split(',');
                                                                date_unchecked[i] = [parseInt(temp_unchecked[0]), parseInt(temp_unchecked[1]), parseInt(temp_unchecked[2])];
                                                            }
                                                        }
                                                    }

                                                    picker.start();
                                                    picker.set('disable', date_disable);

                                                    picker.on({
                                                        open: function() {
                                                            set_id();
                                                            reload_table(date_checked, 'checked__day');
                                                            uncheck_table(date_unchecked, 'picker__day--disabled');



                                                            // $('.picker__day--selected, .picker__day--highlighted:hover, .picker--focused, .picker__day--highlighted').css('background','#fff');
                                                            // $('.picker__day--selected, .picker__day--highlighted:hover, .picker--focused, .picker__day--highlighted').css('color','#000');
                                                            // $('.picker__day--selected, .picker__day--highlighted:hover, .picker--focused, .picker__day--highlighted').css('border','none');
                                                            $('.picker__day').click(function() {
                                                                var value = $(this).data('pick');
                                                                var date = convertDbDate(value);

                                                                var d = new Date(value);
                                                                var date_id = '#' + value;

                                                                if ($(this).hasClass('picker__day--disabled')) {
                                                                    // Remove log
                                                                    $.blockUI({
                                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                                        css: {backgroundColor: 'transparent', border: 0}
                                                                    });

                                                                    $.post('./log/delete/', {id: gid, date: date}, function(data) {
                                                                        if (data.error == 0)
                                                                        {
                                                                            $.post('./goal/habit/', function(data) {
                                                                                if (data.error == 0)
                                                                                {
                                                                                    // picker.set('enable', [[parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]]);

                                                                                    $(date_id).removeClass('picker__day--disabled');
                                                                                    remove_date(date_disable, value);

                                                                                    $('ul.habit-list').html(data.html);

                                                                                    fixHabit(position);
                                                                                    fixCheckbox();
                                                                                }
                                                                            }, "json");
                                                                        }
                                                                    }, "json");
                                                                } else if ($(this).hasClass('checked__day')) {
                                                                    // else if ($(this).hasClass('picker__day--infocus')){
                                                                    // Add new N/A log
                                                                    $.blockUI({
                                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                                        css: {backgroundColor: 'transparent', border: 0}
                                                                    });

                                                                    $.post('./log/add/', {id: gid, value: 2, date: date}, function(data) {
                                                                        if (data.error == 0)
                                                                        {
                                                                            $.post('./goal/habit/', function(data) {
                                                                                if (data.error == 0)
                                                                                {
                                                                                    // picker.set('disable', [[parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]]);

                                                                                    $(date_id).removeClass('checked__day');
                                                                                    remove_date(date_checked, value);
                                                                                    $(date_id).addClass('picker__day--disabled');
                                                                                    date_disable.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);

                                                                                    $('ul.habit-list').html(data.html);

                                                                                    fixHabit(position);
                                                                                    fixCheckbox();
                                                                                }
                                                                            }, "json");
                                                                        }
                                                                    }, "json");
                                                                } else if (!$(this).hasClass('checked__day') && !$(this).hasClass('picker__day-disabled')) {
                                                                    // Add new N/A log
                                                                    $.blockUI({
                                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                                        css: {backgroundColor: 'transparent', border: 0}
                                                                    });

                                                                    $.post('./log/add/', {id: gid, value: 1, date: date}, function(data) {
                                                                        if (data.error == 0)
                                                                        {
                                                                            $.post('./goal/habit/', function(data) {
                                                                                if (data.error == 0)
                                                                                {
                                                                                    $(date_id).addClass('checked__day');
                                                                                    remove_date(date_unchecked, value);

                                                                                    date_checked.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);

                                                                                    $('ul.habit-list').html(data.html);

                                                                                    fixHabit(position);
                                                                                    fixCheckbox();
                                                                                }
                                                                            }, "json");
                                                                        }
                                                                    }, "json");
                                                                }

                                                                //picker.set('select', parseInt(value));
                                                                return false;
                                                            });
                                                        },
                                                        set: function(timestamp) {
                                                            set_id();
                                                            reload_table(date_checked, 'checked__day');
                                                            uncheck_table(date_unchecked, 'picker__day--disabled');
                                                            // $('.picker__day--selected, .picker__day--highlighted:hover, .picker--focused, .picker__day--highlighted').css('background','#fff');
                                                            // $('.picker__day--selected, .picker__day--highlighted:hover, .picker--focused, .picker__day--highlighted').css('color','#000');
                                                            // $('.picker__day--selected, .picker__day--highlighted:hover, .picker--focused, .picker__day--highlighted').css('border','none');

                                                            $('.close_calender').on('click', function() {
                                                                console.log('close cal');
                                                                //   input.cl();
                                                                picker.stop();
                                                            });

                                                            $('.picker__day').click(function() {
                                                                var value = $(this).data('pick');
                                                                var date = convertDbDate(value);

                                                                var d = new Date(value);
                                                                var date_id = '#' + value;

                                                                if ($(this).hasClass('picker__day--disabled')) {
                                                                    // // Remove log
                                                                    $.blockUI({
                                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                                        css: {backgroundColor: 'transparent', border: 0}
                                                                    });

                                                                    $.post('./log/delete/', {id: gid, date: date}, function(data) {
                                                                        if (data.error == 0)
                                                                        {
                                                                            $.post('./goal/habit/', function(data) {
                                                                                if (data.error == 0)
                                                                                {
                                                                                    // picker.set('enable', [[parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]]);

                                                                                    $(date_id).removeClass('picker__day--disabled');
                                                                                    remove_date(date_disable, value);

                                                                                    $('ul.habit-list').html(data.html);

                                                                                    fixHabit(position);
                                                                                    fixCheckbox();
                                                                                }
                                                                            }, "json");
                                                                        }
                                                                    }, "json");
                                                                } else if ($(this).hasClass('checked__day')) {
                                                                    // else if ($(this).hasClass('picker__day--infocus')){
                                                                    // Add new log
                                                                    $.blockUI({
                                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                                        css: {backgroundColor: 'transparent', border: 0}
                                                                    });

                                                                    $.post('./log/add/', {id: gid, value: 2, date: date}, function(data) {
                                                                        if (data.error == 0)
                                                                        {
                                                                            $.post('./goal/habit/', function(data) {
                                                                                if (data.error == 0)
                                                                                {
                                                                                    // picker.set('disable', [[parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]]);

                                                                                    $(date_id).removeClass('checked__day');
                                                                                    remove_date(date_checked, value);
                                                                                    $(date_id).addClass('picker__day--disabled');
                                                                                    date_disable.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);

                                                                                    $('ul.habit-list').html(data.html);

                                                                                    fixHabit(position);
                                                                                    fixCheckbox();
                                                                                }
                                                                            }, "json");
                                                                        }
                                                                    }, "json");
                                                                } else if (!$(this).hasClass('checked__day') && !$(this).hasClass('picker__day-disabled')) {
                                                                    // Add new N/A log
                                                                    $.blockUI({
                                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                                        css: {backgroundColor: 'transparent', border: 0}
                                                                    });

                                                                    $.post('./log/add/', {id: gid, value: 1, date: date}, function(data) {
                                                                        if (data.error == 0)
                                                                        {
                                                                            $.post('./goal/habit/', function(data) {
                                                                                if (data.error == 0)
                                                                                {
                                                                                    $(date_id).addClass('checked__day');
                                                                                    remove_date(date_unchecked, value);

                                                                                    date_checked.push([parseInt(d.getFullYear()), parseInt(d.getMonth()), parseInt(d.getDate())]);

                                                                                    $('ul.habit-list').html(data.html);

                                                                                    fixHabit(position);
                                                                                    fixCheckbox();
                                                                                }
                                                                            }, "json");
                                                                        }
                                                                    }, "json");
                                                                }

                                                                // picker.set('select', parseInt(value));
                                                                return false;
                                                            });
                                                        },
                                                        render: function() {
                                                            set_id();
                                                        }
                                                    });

                                                    picker.open();
                                                    $(document).on('click', function() {
                                                        picker.stop();
                                                    });
                                                    $('.close_calender').on('click', function() {
                                                        console.log('close cal');
                                                        //   input.cl();
                                                        picker.stop();
                                                    });
                                                }, "json");
                                            });

                                            $("ul.habit-list input.habits__checkbox").on('click', function() {
                                                //console.log(value + '=>1');
                                            });


                                            $(document).on('ifChanged', "ul.habit-list input.habits__checkbox", function(e) {
                                                var _this = $(this);
                                                var full_date_php = _this.attr('gdate');
                                                var gid = _this.attr('gid');
                                                var value = _this.data('value');

                                                var isChecked = e.currentTarget.checked;
                                                var notava = false;

                                                console.log(isChecked, value, '<==');
                                                if (isChecked && value == 0) {
                                                    value = 1;
                                                } else if (isChecked && value == 1) {
                                                    //value = 2;
                                                } else if (!isChecked && value == 1) {
                                                    value = 2;
                                                    notava = true;
                                                } else if (!isChecked && value == 2) {
                                                    value = 0;
                                                }

                                                console.log(isChecked, value, '<==>');
                                                //   return false;

                                                // return false;

                                                // Get current position
                                                position = $('#habit-id').scrollTop();

                                                if (value === 1 || value === 2)
                                                {
                                                    $.blockUI({
                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                        css: {backgroundColor: 'transparent', border: 0}
                                                    });

                                                    $.post('./log/add/', {id: gid, value: value, date: full_date_php}, function(data) {
                                                        if (data.error == 0)
                                                        {
                                                            $.post('./goal/habit/', function(data) {
                                                                if (data.error == 0)
                                                                {
                                                                    $('ul.habit-list').html(data.html);

                                                                    fixHabit(position);
                                                                    fixCheckbox();

                                                                }
                                                            }, "json");
                                                        }
                                                    }, "json");
                                                } else {
                                                    $.blockUI({
                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                        css: {backgroundColor: 'transparent', border: 0}
                                                    });
                                                    $.post('./log/delete/', {id: gid, date: full_date_php}, function(data) {
                                                        if (data.error == 0)
                                                        {
                                                            $.post('./goal/habit/', function(data) {
                                                                if (data.error == 0)
                                                                {
                                                                    $('ul.habit-list').html(data.html);

                                                                    fixHabit(position);
                                                                    fixCheckbox();
                                                                }
                                                            }, "json");
                                                        }
                                                    }, "json");
                                                }
                                                //$('.landing_habbit input').iCheck('update');
                                                if (notava) {
                                                    $(this).next('.iCheck-helper').css('border', '1px solid red !important');
                                                    $(this).next('.iCheck-helper').css('opacity', '1 !important');
                                                }

                                            });

                                            $("ul.character-list").on('click', 'a.arrow-up', function() {
                                                $.blockUI({
                                                    message: '<img src="./img/ajax-loader.gif" />',
                                                    css: {backgroundColor: 'transparent', border: 0}
                                                });

                                                var _this = $(this);
                                                var index = _this.attr('index');
                                                var downid = _this.attr('gid');
                                                var nextindex = parseInt(index) + 1;
                                                var upid = $('.character-up-' + nextindex).attr('gid');

                                                $.post('./goal/swap', {downid: downid, upid: upid, type: 'character'}, function(data) {
                                                    if (data.error == 0)
                                                    {
                                                        $('ul.character-list').html(data.html);
                                                    }
                                                }, "json");
                                            });

                                            $("ul.character-list").on('click', 'a.arrow-down', function() {
                                                $.blockUI({
                                                    message: '<img src="./img/ajax-loader.gif" />',
                                                    css: {backgroundColor: 'transparent', border: 0}
                                                });

                                                var _this = $(this);
                                                var index = _this.attr('index');
                                                var upid = _this.attr('gid');
                                                var previndex = parseInt(index) - 1;
                                                var downid = $('.character-down-' + previndex).attr('gid');

                                                $.post('./goal/swap', {downid: downid, upid: upid, type: 'character'}, function(data) {
                                                    if (data.error == 0)
                                                    {
                                                        $('ul.character-list').html(data.html);
                                                    }
                                                }, "json");
                                            });

                                            bindEvents();

                                        });

                                        // DND START 

                                        var is_drag_1 = 0;
                                        var drag_id_1 = '';
                                        var is_drag_2 = 0;
                                        var drag_id_2 = '';
                                        var is_drag_3 = 0;
                                        var drag_id_3 = '';

                                        jQuery(document).bind("ready", function() {

                                            //Habit
                                            $('.habit-list li').each(function() {
                                                var a = $(this);
                                                drag_hover_1(a);
                                                a.hover(function() {
                                                    $(this).css("cursor", "move");
                                                }, function() {
                                                    $(this).css("cursor", "default");
                                                });
                                            });

                                            //Task
                                            $('.task-list li > div').each(function() {
                                                var a = $(this);
                                                drag_hover_2(a);
                                                a.hover(function() {
                                                    $(this).css("cursor", "move");
                                                }, function() {
                                                    $(this).css("cursor", "default");
                                                });
                                            });

                                            //Character
                                            $('.character-list li').each(function() {
                                                var a = $(this);
                                                drag_hover_3(a);
                                                a.hover(function() {
                                                    $(this).css("cursor", "move");
                                                }, function() {
                                                    $(this).css("cursor", "default");
                                                });
                                            });
                                        });

                                        //---DRAG AND DROP --/

                                        function allowDrop(ev)
                                        {
                                            ev.preventDefault();
                                        }

                                        //--Habit List--/

                                        function dragStart_1(ev)
                                        {
                                            var data_send = ev.target.id;
                                            drag_id_1 = ev.target.id;
                                            is_drag_1 = 1;
                                            ev.dataTransfer.setData("Text", data_send);
                                            is_drag_2 = 0;
                                            drag_id_2 = '';
                                            is_drag_3 = 0;
                                            drag_id_3 = '';
                                        }

                                        function drop_above_1(ev)
                                        {
                                            if (is_drag_1 == 1) {
                                                var id = ev.dataTransfer.getData("Text");
                                                drag_id_1 = id;
                                                var p = $(ev.target);
                                                while (!p.is("li"))
                                                    p = p.parent();
                                                drop_id_1 = p.attr('id');
                                                if (drop_id_1 != drag_id_1) {
                                                    $('#' + drop_id_1).before($('#' + drag_id_1));

                                                    // Get current position
                                                    position = $('#habit-id').scrollTop();

                                                    var date = '8 February, 2018';

                                                    // begin ajax call
                                                    $.blockUI({
                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                        css: {backgroundColor: 'transparent', border: 0}
                                                    });

                                                    $.post('./goal/dragndrop', {dragid: drag_id_1, dropid: drop_id_1, type: 'habit', order: 'self_order', date: date}, function(response) {
                                                        if (response.error == 0)
                                                        {
                                                            $('ul.habit-list').html(response.html);
                                                            fixHabit(position);
                                                            fixCheckbox();
                                                            $('.habit-list li').each(function() {
                                                                var a = $(this);
                                                                drag_hover_1(a);
                                                                a.hover(function() {
                                                                    $(this).css("cursor", "move");
                                                                }, function() {
                                                                    $(this).css("cursor", "default");
                                                                });
                                                            });
                                                        }
                                                    }, "json");
                                                }
                                                $('.habit-list li').css('border-top', 'none');
                                                $('.habit-list li').css('padding-top', '0px');
                                                is_drag_1 = 0;
                                                drag_id_1 = '';
                                            }
                                            ev.preventDefault();
                                        }
                                        function drag_hover_1(a) {
                                            a.on('dragenter dragover', function() {
                                                hover_drop_id = a.attr('id');
                                                if (drag_id_1 != "" && drag_id_1 != hover_drop_id && $('#' + drag_id_1).next().attr('id') != hover_drop_id) {
                                                    a.css('border-top', 'solid 1px #000');
                                                }
                                            });
                                            a.on('dragleave dragend', function() {
                                                $('.habit-list li').css('border-top', 'none');
                                                $('.habit-list li').css('padding-top', '0px');
                                            });
                                        }

                                        //--Task List--//

                                        function dragStart_2(ev)
                                        {
                                            var data_send = ev.target.id;
                                            drag_id_2 = ev.target.id;
                                            is_drag_2 = 1;
                                            ev.dataTransfer.setData("Text", data_send);
                                            is_drag_1 = 0;
                                            drag_id_1 = '';
                                            is_drag_3 = 0;
                                            drag_id_3 = '';
                                        }

                                        function drop_above_2(ev)
                                        {
                                            ////alert(is_drag_2);
                                            if (is_drag_2 == 1) {
                                                //console.log(ev);
                                                var id = ev.dataTransfer.getData("Text");

                                                drag_id_2 = id;
                                                var p = $(ev.target);
                                                //alert(p.is("div"));
                                                while (!p.is("div"))
                                                    p = p.parent();

                                                p = p.parent().parent();
//                                                        drop_id_2 = p.find('> div').attr('id');
                                                drop_id_2 = p.attr('id');


                                                if (drop_id_2 != drag_id_2) {
                                                    var task_drop = $('#' + drop_id_2).parent();
                                                    var task_drag = $('#' + drag_id_2).parent();
                                                    if (task_drop.parent().get(0) === task_drag.parent().get(0)) {
                                                        task_drop.before(task_drag);

                                                        // begin ajax call
                                                        $.blockUI({
                                                            message: '<img src="./img/ajax-loader.gif" />',
                                                            css: {backgroundColor: 'transparent', border: 0}
                                                        });

                                                        var current_view_typ = $('#view_type').val();

                                                        $.post('./goal/dragndrop', {dragid: drag_id_2, dropid: drop_id_2, type: 'task', order: 'self_order',current_view_typ:current_view_typ}, function(response) {
                                                            if (response.error == 0)
                                                            {
                                                                //alert(11);
                                                                $('#task_displayer').html(response.html);
                                                                fixHasSub();
                                                                bindEvents();
                                                                $('.task-list li > div').each(function() {
                                                                    var a = $(this);
                                                                    drag_hover_2(a);
                                                                    a.hover(function() {
                                                                        $(this).css("cursor", "move");
                                                                    }, function() {
                                                                        $(this).css("cursor", "default");
                                                                    });
                                                                });
                                                            }
                                                        }, "json");
                                                    }
                                                }
                                                $('.task-list li').css('border-top', 'none');
                                                $('.task-list li').css('padding-top', '0px');
                                                is_drag_2 = 0;
                                                drag_id_2 = '';
                                            }
                                            ev.preventDefault();
                                        }
                                        function drag_hover_2(a) {
                                            a.on('dragenter dragover', function() {
                                                hover_drop_id = a.attr('id');
                                                // console.log("hover id:"+hover_drop_id);
                                                var parent1 = $('#' + drag_id_2).parent().parent();
                                                var parent2 = a.parent().parent();
                                                // console.log("p1:"+parent1+";p2:"+parent2);
                                                var kt2 = $('#' + drag_id_2).parent().next().find('> div').attr('id');
                                                if (drag_id_2 != "" && drag_id_2 != hover_drop_id && parent1.get(0) === parent2.get(0) && kt2 != hover_drop_id) {
                                                    a.css('border-top', 'solid 1px #000');
                                                }
                                            });
                                            a.on('dragleave dragend', function() {
                                                $('.task-list li > div').css('border-top', 'none');
                                                $('.task-list li > div').css('padding-top', '0px');
                                                //console.log($('#'+drag_id_2).parent("ul").attr('id')+"    ;    "+ $('#'+hover_drop_id).parent("ul").attr('id'));
                                            });
                                        }

                                     

                                        function dragStart_3(ev)
                                        {
                                            var data_send = ev.target.id;
                                            drag_id_3 = ev.target.id;
                                            is_drag_3 = 1;
                                            ev.dataTransfer.setData("Text", data_send);
                                            is_drag_1 = 0;
                                            drag_id_1 = '';
                                            is_drag_2 = 0;
                                            drag_id_2 = '';
                                        }

                                        function drop_above_3(ev)
                                        {
                                            if (is_drag_3 == 1) {
                                                var id = ev.dataTransfer.getData("Text");
                                                drag_id_3 = id;
                                                var p = $(ev.target);
                                                while (!p.is("li"))
                                                    p = p.parent();
                                                drop_id_3 = p.attr('id');
                                                if (drop_id_3 != drag_id_3) {
                                                    $('#' + drop_id_3).before($('#' + drag_id_3));

                                                    // begin ajax call
                                                    $.blockUI({
                                                        message: '<img src="./img/ajax-loader.gif" />',
                                                        css: {backgroundColor: 'transparent', border: 0}
                                                    });

                                                    $.post('./goal/dragndrop', {dragid: drag_id_3, dropid: drop_id_3, type: 'character', order: 'self_order'}, function(response) {
                                                        if (response.error == 0)
                                                        {
                                                            $('ul.character-list').html(response.html);
                                                            $('.character-list li').each(function() {
                                                                var a = $(this);
                                                                drag_hover_3(a);
                                                                a.hover(function() {
                                                                    $(this).css("cursor", "move");
                                                                }, function() {
                                                                    $(this).css("cursor", "default");
                                                                });
                                                            });
                                                        }
                                                    }, "json");
                                                }
                                                $('.character-list li').css('border-top', 'none');
                                                $('.character-list li').css('padding-top', '0px');
                                                is_drag_3 = 0;
                                                drag_id_3 = '';
                                            }
                                            ev.preventDefault();
                                        }
                                        function drag_hover_3(a) {
                                            a.on('dragenter dragover', function() {
                                                hover_drop_id = a.attr('id');
                                                if (drag_id_3 != "" && drag_id_3 != hover_drop_id && $('#' + drag_id_3).next().attr('id') != hover_drop_id) {
                                                    a.css('border-top', 'solid 1px #000');
                                                }
                                            });
                                            a.on('dragleave dragend', function() {
                                                $('.character-list li').css('border-top', 'none');
                                                $('.character-list li').css('padding-top', '0px');
                                            });
                                        }
*/